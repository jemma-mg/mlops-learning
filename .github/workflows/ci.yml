name: CI Pipeline

on:
  push:
    branches: [ main, dev ]
  pull_request:
    branches: [ main, dev ]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: [3.12]
        
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        
      - name: Set up Python
        # This is the version of the action for setting up Python, not the Python version.
        uses: actions/setup-python@v5
        with:
          # Semantic version range syntax or exact version of a Python version
          python-version: ${{ matrix.python-version }}
          # cache: 'pip'

      # You can test your matrix by printing the current Python version
      - name: Display Python version
        run: python -c "import sys; print(sys.version)"
        
      - name: Upgrade pip, setuptools, wheel
        run: |
          python -m pip install --upgrade pip setuptools wheel

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install --upgrade setuptools wheel
          pip install -r requirements.txt

      - name: Authenticate to Google Cloud
        run: |
          cat <<EOF > gcp-key.json
          ${{ secrets.GCP_MLOPS_STORAGE_ACCESS_KEY }}
          EOF
          gcloud auth activate-service-account --key-file=gcp-key.json
          gcloud config set project mlops-sept25

      - name: Set GOOGLE_APPLICATION_CREDENTIALS
        run: echo "GOOGLE_APPLICATION_CREDENTIALS=gcp-key.json" >> $GITHUB_ENV
          
      - name: Pull data & model from DVC remote
        run: |
          dvc pull
          dvc checkout

      - name: Run Pytest
        run: pytest --junitxml=results.xml --maxfail=3 --disable-warnings -q
        
      # - name: Test with pytest
      #   run: |
      #     pip install pytest pytest-cov
      #     pytest tests/test_data_validation.py --doctest-modules --junitxml=junit/test-results.xml --cov=com --cov-report=xml --cov-report=html
      #     pytest tests/test_model_eval.py --doctest-modules --junitxml=junit/test-results.xml --cov=com --cov-report=xml --cov-report=html

      # - name: Post test report to PR using CML
      #   if: github.event_name == 'pull_request'
      #   env:
      #     REPO_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      #   run: |
      #     pip install cml
      #     cml comment create results.xml

      - name: Convert test results to Markdown
        run: |
          echo "## ðŸ§ª Test Report" > report.md
          echo "Posted at $(date)" >> report.md
          echo "\`\`\`xml" >> report.md
          cat results.xml >> report.md
          echo "\`\`\`" >> report.md
      
      - name: Post test report to PR using CML
        if: always()
        env:
          REPO_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          npm install -g @dvcorg/cml
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            cml comment create report.md
          else
            echo "Not a pull request â€” skipping comment."
          fi
          
